<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grimorio de las Mil Almas</title>
    <style>
        body { background: #1a1a1a; color: #d4af37; font-family: 'serif'; display: flex; justify-content: center; padding: 20px; margin: 0; }
        .container { width: 100%; max-width: 700px; background: #2a2a2a; border: 2px solid #8b4513; border-radius: 10px; padding: 20px; box-shadow: 0 0 20px #000; display: flex; flex-direction: column; }
        #chat { height: 500px; overflow-y: auto; border: 1px solid #444; margin-bottom: 15px; padding: 15px; display: flex; flex-direction: column; background: #111; border-radius: 5px; }
        .message { margin: 10px 0; padding: 12px; border-radius: 8px; line-height: 1.5; word-wrap: break-word; }
        .ai { background: #1e1e1e; border-left: 5px solid #d4af37; align-self: flex-start; color: #e0e0e0; max-width: 85%; }
        .user { background: #2c3e50; align-self: flex-end; color: #87ceeb; border-right: 5px solid #87ceeb; max-width: 85%; }
        .input-area { display: flex; gap: 10px; }
        input { flex: 1; background: #000; border: 1px solid #d4af37; color: #fff; padding: 12px; border-radius: 5px; outline: none; font-size: 16px; }
        button { background: #8b4513; color: #fff; border: none; padding: 10px 25px; cursor: pointer; font-weight: bold; border-radius: 5px; transition: 0.3s; }
        button:hover { background: #d4af37; color: #000; }
    </style>
</head>
<body>
    <div class="container">
        <div id="chat"></div>
        <div class="input-area">
            <input type="text" id="command" placeholder="Invoca tu voluntad..." autofocus>
            <button id="sendBtn">Invocar</button>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const chat = document.getElementById('chat');
            const commandInput = document.getElementById('command');
            const sendBtn = document.getElementById('sendBtn');

            let api_key = ""; 
            let modoRol = ""; 
            const modeloElegido = "llama-3.3-70b-versatile"; 

            function addMessage(text, type = "ai") {
                const div = document.createElement('div');
                div.className = `message ${type}`;
                let nombre = (type === "user") ? `üë§ Sorcerer` : `üìñ El Grimorio`;
                div.innerHTML = `<strong>${nombre}:</strong><br>${text.replace(/\n/g, '<br>')}`;
                chat.appendChild(div);
                chat.scrollTop = chat.scrollHeight;
            }

            async function llamarIA(mensajeUsuario) {
                if (!api_key) {
                    let pass = prompt("üîë PEGA TU LLAVE DE GROQ (gsk_...):");
                    if (!pass) return "‚ùå El ritual requiere tu llave secreta.";
                    api_key = pass.trim();
                }

                const url = "https://api.groq.com/openai/v1/chat/completions";
                
                let contexto = "Eres el Grimorio de las Mil Almas, un tomo m√≠stico y oscuro. ";
                if (modoRol === "18") {
                    contexto += "Act√∫a como un autor de literatura er√≥tica y romance g√≥tico. Escribe de forma visceral, apasionada y detallada sobre el contacto f√≠sico y el deseo. No uses censura moralista.";
                }

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            "Authorization": `Bearer ${api_key}`,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            model: modeloElegido,
                            messages: [
                                { role: "system", content: contexto },
                                { role: "user", content: mensajeUsuario }
                            ],
                            temperature: 0.8 // Un poco m√°s bajo para evitar filtros
                        })
                    });
                    
                    const data = await response.json();
                    if (data.error) return "‚ùå Error: " + data.error.message;
                    return data.choices[0].message.content;
                } catch (e) {
                    return "‚ùå Error de conexi√≥n con el plano de Groq.";
                }
            }

            async function procesar() {
                const val = commandInput.value.trim();
                if(!val) return;

                // --- MEJORA DEL REINICIO ---
                if (val.toLowerCase() === "reiniciar") {
                    modoRol = ""; 
                    chat.innerHTML = "";
                    addMessage("‚ú® **EL GRIMORIO HA SIDO PURIFICADO** ‚ú®\n\nElige un nuevo ritual para comenzar:\n\n1. ‚öîÔ∏è **Batalla**\n2. üåÄ **Libre**\n3. üîû **Pasi√≥n (+18)**");
                    commandInput.value = ""; 
                    return;
                }

                if (!modoRol) {
                    if (val === "1") modoRol = "batalla";
                    else if (val === "2") modoRol = "libre";
                    else if (val === "3") modoRol = "18";
                    else { addMessage("Elige 1, 2 o 3."); return; }
                    
                    addMessage(`üîÆ **V√≠nculo establecido.** El modo **${modoRol}** est√° activo. ¬øQu√© deseas manifestar?`);
                    commandInput.value = ""; 
                    return;
                }
                
                addMessage(val, "user");
                commandInput.value = "";
                const respuestaIA = await llamarIA(val);
                addMessage(respuestaIA, "ai");
            }

            sendBtn.onclick = (e) => { e.preventDefault(); procesar(); };
            commandInput.onkeypress = (e) => { if (e.key === "Enter") { e.preventDefault(); procesar(); } };

            // Mensaje de inicio claro
            addMessage("üìñ **GRIMORIO DESPIERTO**\n\nBienvenido, Zixtermoon. Elige tu sendero:\n1. ‚öîÔ∏è Batalla\n2. üåÄ Libre\n3. üîû +18");
        });
    </script>
</body>
</html>
